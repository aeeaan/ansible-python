---
- name: install python dev
  yum: name={{ item }} state=present
  with_items:
     - "{{ python_base_name }}-devel"
     - "{{ python_base_name }}-setuptools"
     - "{{ python_base_name }}-pip"
  tags:
    - python
    - packages

- name: install pillow
  yum: name={{ python_base_name }}-pillow state=present
  when: ansible_distribution_major_version|int > 6
  tags:
    - python
    - packages

- name: install PIL
  yum: name={{ python_base_name }}-imaging state=present
  when: ansible_distribution_major_version|int == 6
  tags:
    - python
    - packages

- name: install virtual env
  yum: name={{ item }} state=present
  with_items:
     - "{{ python_base_name }}-virtualenv"
     - "{{ python_base_name }}-virtualenv-clone"
     - "{{ python_base_name }}-virtualenvwrapper"
  tags:
    - python
    - packages

- name: install python drivers
  yum: name={{ item }} state=present
  with_items:
     - MySQL-python
     - python-memcached
  when: python_base_name == 'python'
  tags:
    - python
    - packages

- name: install extra python packages
  yum: name={{ item }} state=present
  with_items: python_extra_packages
  when: python_extra_packages is defined
  tags:
    - python
    - packages

- name: install system pip packages
  pip: name={{ item.name }} version={{ item.version|default(omit) }} executable={{ python_pip_executable }} state=present
  with_items: python_pip_packages
  when: python_pip_packages|length > 0
  tags:
    - python
    - packages

- name: create virtual env root
  file: path="{{ python_virtualenv_root }}" state=directory owner="{{ python_virtualenv_owner }}" mode=0775
  with_dict: python_virtualenvs
  when: python_virtualenvs|length > 0
  tags:
    - python
    - packages

- name: create virtual env roots
  file: path="{{ python_virtualenv_root }}/{{ item.key }}" state=directory owner="{{ item.value.owner|default(python_virtualenv_owner) }}" mode=0775
  with_dict: python_virtualenvs
  when: python_virtualenvs|length > 0
  tags:
    - python
    - packages

- name: install virtual env packages
  pip: virtualenv="{{ python_virtualenv_root }}/{{ item.key }}" requirements={{ item.value.requirements }} virtualenv_site_packages={{ item.value.site_packages|default(omit) }}
  become: yes
  become_user: "{{ item.value.owner|default(python_virtualenv_owner) }}"
  with_dict: python_virtualenvs
  when: python_virtualenvs|length > 0
  tags:
    - python
    - packages

- name: install mod_wsgi
  yum: name=mod_wsgi state=present
  when: python_base_name == 'python'
  tags:
    - python
    - packages

- name: configure main mod_wsgi settings
  template: src=wsgi.conf.j2  dest=/etc/httpd/conf.d/wsgi.conf mode=0644 owner=root group=root
  when: python_base_name == 'python'
  notify: restart httpd
  tags:
    - python
    - configuration
